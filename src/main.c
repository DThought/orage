/* xfcalendar
 *
 * Copyright (C) 2002 Mickael Graf (korbinus@linux.se)
 *
 * This program is free software; you can redistribute it and/or modify it 
 * under the terms of the GNU General Public License as published by the
 * Free Software Foundation; either version 2 of the License, or (at your
 * option) any later version.  This program is distributed in the hope
 * that it will be useful, but WITHOUT ANY WARRANTY; without even the
 * implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
 * PURPOSE.  See the GNU General Public License for more details.  You
 * should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc., 
 * 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA. 
 */

/*
 * Initial main.c file generated by Glade. Edit as required.
 * Glade will not overwrite this file.
 */

#ifdef HAVE_CONFIG_H
#include <config.h>
#endif

#include <sys/stat.h>

#ifdef HAVE_ERRNO_H
#include <errno.h>
#endif
#ifdef HAVE_STDLIB_H
#include <stdlib.h>
#endif

#include <libxfce4util/i18n.h>
#include <libxfce4util/util.h>
#include <libxfcegui4/libxfcegui4.h>
#include <libxfcegui4/netk-trayicon.h>
#include <gtk/gtk.h>

#include "interface.h"
#include "support.h"

/* session client handler */
static SessionClient	*session_client = NULL;

/* tray icon popup menu */
static GtkWidget	*trayMenu = NULL;

/* main window */
static GtkWidget	*mainWindow = NULL;

void
createRCDir(void)
{
	gchar *calpath;

	calpath = xfce_get_userfile("xfcalendar", NULL);

	if (!g_file_test(calpath, G_FILE_TEST_IS_DIR)) {
		if (mkdir(calpath, 0755) < 0) {
			g_error("Unable to create directory %s: %s",
					calpath, g_strerror(errno));
		}
	}

	g_free(calpath);
}

int mark_appointments(GtkWidget *w);
int setup_signals(GtkWidget *w);
gint alarm_clock(gpointer p);
void keep_tidy(void);
void set_cal();
extern void on_about1_activate(GtkMenuItem *, gpointer);

/*
 * SaveYourself callback
 *
 * This is called when the session manager requests the client to save its
 * state.
 */
/* ARGUSED */
static void
save_yourself_cb(gpointer data, int save_style, gboolean shutdown,
                 int interact_style, gboolean fast)
{
	/* FIXME: Mickael, insert save code here! */
}

/*
 * Die callback
 *
 * This is called when the session manager requests the client to go down.
 */
static void
die_cb(gpointer data)
{
	gtk_main_quit();
}

/*
 */
static void
icon_button_press_cb(GtkWidget *icon, GdkEventButton *event, gpointer user_data)
{
	if (event->button == 1 && event->type == GDK_2BUTTON_PRESS) {
		if (GTK_WIDGET_VISIBLE(mainWindow))
			gtk_widget_hide(mainWindow);
		else
			gtk_widget_show(mainWindow);
	}
	else if (event->button == 3) {
		gtk_menu_popup(GTK_MENU(trayMenu), NULL, NULL, NULL, NULL,
				event->button, gtk_get_current_event_time());
	}
}

/*
 */
static void
icon_popup_menu_cb(GtkWidget *icon, gpointer user_data)
{
	gtk_menu_popup(GTK_MENU(trayMenu), NULL, NULL, NULL, NULL,
			0, gtk_get_current_event_time());
}

int
main(int argc, char *argv[])
{
	GtkWidget *trayicon;
	GtkWidget *image;
	GtkWidget *eventbox;
	GtkWidget *menuItem;

	xfce_textdomain(GETTEXT_PACKAGE, PACKAGE_LOCALE_DIR, "UTF-8");

	gtk_set_locale();
	gtk_init(&argc, &argv);

	/* 
	 * try to connect to the session manager
	 */
	session_client = client_session_new(argc, argv, NULL,
			SESSION_RESTART_IF_RUNNING, 50);
	session_client->save_yourself = save_yourself_cb;
	session_client->die = die_cb;
	(void)session_init(session_client);

	add_pixmap_directory(PACKAGE_DATA_DIR G_DIR_SEPARATOR_S PACKAGE
			G_DIR_SEPARATOR_S "pixmaps");

	/*
	 * The following code was added by Glade to create one of each
	 * component (except popup menus), just so that you see something
	 * after building the project. Delete any components that you don't
	 * want shown initially.
	 */
	mainWindow = create_XFCalendar();
	set_cal(mainWindow);
	mark_appointments(mainWindow);
	setup_signals(mainWindow);
	gtk_widget_show(mainWindow);

	/*
	 * Create the tray icon popup menu
	 */
	trayMenu = gtk_menu_new();
	menuItem = gtk_menu_item_new_with_label(_("About XFCalendar"));
	g_signal_connect(menuItem, "activate", G_CALLBACK(on_about1_activate),
			NULL);
	gtk_menu_shell_append(GTK_MENU_SHELL(trayMenu), menuItem);
	gtk_widget_show(menuItem);
	menuItem = gtk_separator_menu_item_new();
	gtk_menu_shell_append(GTK_MENU_SHELL(trayMenu), menuItem);
	gtk_widget_show(menuItem);
	menuItem = gtk_image_menu_item_new_from_stock(GTK_STOCK_QUIT, NULL);
	g_signal_connect(menuItem, "activate", G_CALLBACK(gtk_main_quit), NULL);
	gtk_menu_shell_append(GTK_MENU_SHELL(trayMenu), menuItem);
	gtk_widget_show(menuItem);

	/*
	 * Create the tray icon
	 */
	trayicon = netk_tray_icon_new(GDK_SCREEN_XSCREEN(
				gdk_screen_get_default()));
	eventbox = gtk_event_box_new();
	image = gtk_image_new_from_stock(GTK_STOCK_INDEX, GTK_ICON_SIZE_MENU);
	gtk_container_add(GTK_CONTAINER(eventbox), image);
	gtk_container_add(GTK_CONTAINER(trayicon), eventbox);
	gtk_widget_add_events(trayicon, GDK_BUTTON_PRESS_MASK |
			GDK_FOCUS_CHANGE_MASK);
	g_signal_connect(trayicon, "button_press_event",
			G_CALLBACK(icon_button_press_cb), NULL);
	g_signal_connect(trayicon, "popup_menu",
			G_CALLBACK(icon_popup_menu_cb), NULL);
	gtk_widget_show_all(trayicon);
	
	/*
	 * Now it's serious, the application is running, so we create the RC
	 * directory
	 */
	createRCDir();

	gtk_main();
	keep_tidy();

	return(EXIT_SUCCESS);
}

